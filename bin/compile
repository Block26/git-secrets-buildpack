#!/bin/bash

indent() {
  sed -u 's/^/       /'
}

echo "-----> Install git-secrets provider"

BUILD_DIR=$1
VENDOR_DIR="$BUILD_DIR/vendor"
INSTALL_DIR="$BUILD_DIR/vendor/git-secrets-provider"
ENV_DIR=$3

if [ ! -f "$ENV_DIR/GIT_SECRETS_FILE_URL" ]; then
	echo "-----> You must define the environment variable GIT_SECRETS_FILE_URL."
	exit 1
fi

mkdir -p $INSTALL_DIR

GIT_SECRETS_FILE_URL=$(cat $ENV_DIR/GIT_SECRETS_FILE_URL)
GIT_SECRETS_FILE=`basename $GIT_SECRETS_FILE_URL`
curl -o $INSTALL_DIR/$GIT_SECRETS_FILE $GIT_SECRETS_FILE_URL 2>&1 | indent

PROFILE_PATH="$BUILD_DIR/.profile.d/git-secrets.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo "while IFS=\n read -r line; do /app/vendor/git-secrets/git-secrets --add --global \"\$line\"; done < /app/vendor/git-secrets-provider/$GIT_SECRETS_FILE" >> $PROFILE_PATH
